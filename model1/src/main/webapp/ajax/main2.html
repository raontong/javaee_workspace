<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<title>Insert title here</title>
<style>
    .container{
        width: 650px;
        height: 500px;
        background-color: azure;
        margin:auto;
    }
    .aside{
        width: 150px;
        height: 100%;
        background-color: aqua;
        float:left;
    }
    .aside input{
        width: 90%;
    }
    .aside button{
        width: 40% 1px;
    }
    .content{
        width: 500px;
        height: 100%;
        background-color: yellow;
        float: left;
    }
</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
//목록을 출력하는 작업은 꼭 등록할때만이 아니라 유저가 처음 브라우저로 main.html을 요청한 시점부터도
//목록이 나와야 하므로 재사용 가능성이 높아서 별도 함수로 정의
function render(list){
   console.log("전달받은 배열은 " + list);
   //랜더링 작업은 상당히 고달픈 작업이면서 시간이 많이 걸림. 따라서 이와 관련되어 나온 기술이 Vue, React.js..
   //document.querySelector(".content").innerHTML="<table>";
   let tag = "<table width='100%' border='1px'>";
   tag += "<head>";
   tag += "<tr>";
   tag += "<th>ID</th>";
   tag += "<th>Name</th>";
   tag += "<th>Email</th>";
   tag += "</tr>";
   tag += "</head>";
   tag += "<tbody>";
   for(let i=0; i < list.length; i++)   {
      let obj= list[i];
      tag += "<tr>";
      tag += "<th>"+obj.id+"</th>";
      tag += "<th>"+obj.name+"</th>";
      tag += "<th>"+obj.email+"</th>";
      tag += "</tr>";
   }
   tag += "</tbody>";   
   tag += "</table>";
   
   $(".content").html(tag);
}
//서버에 목록 요청(비동기적)
function getList(){
   //비동기적 요청을 담당하는 XMLHttpRequest 객체를 사용
   let xhttp = new XMLHttpRequest();
   
   //서버에 
   xhttp.onload=function(){
      //서버에서 전송한 json문자열을 파싱하여 화면에 랜더링
      console.log("서버가 응답한 데이터는 ", this.responseText);
      
      //파싱 시 주의점 ?json표기법에 따라야함
     let memberList = JSON.parse(this.responseText);
      
      render(memberList);
   }
   
   xhttp.open("GET","/ajax/async_list.jsp"); //요청준비
   xhttp.send(); //여기서 요청 발생
}
function regist(){
   //서버에 요청을 시도하되 비동기로 요청하자
   let xhttp = new XMLHttpRequest(); //JS의 비동기 통신 객체
   
   xhttp.onload=function(){
      //서버에서 응답정보가 도착하면 호출되는익명함수 역활로서는 콜백함수(역활)
      //console.log("서버에서 보내온 데이터는 " + this.responseText)
      
      //let memberList = JSON.parse(this.responseText);
      //console.log(memberList);
      
      //서버에서 가져온 데이터를 화면에 출력
      //getList(memberList);
      console.log("등록 완료");
      getList();
   }
   
   xhttp.open("POST","/ajax/async_regist.jsp"); //요청방법 및 요청 주소 지정
   xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; UTF=utf-8");//전송시 헤더 지정
   //xhttp.send(); //비동기 요청 출발~(이때 요청 시도자체를 자바스크립트가 하지않고 브라우저에게 시킴...)
                     //자스는 응답정보가 올때까지 대기상태에 빠지지 않고, 자신의 다른일을 할 수 있다(비동기)
                  //응답이 올때까지 기다리지 않았기 때문에. 비동기
                  //브라우저가 응답을 받아오면, 자바스립트에게 알립.. 이때 자스의 XMLHttpRequest의  onload속성에 지정한
                  //익명함수인 콜백함수를 호출하게 된다(누가?js가)
   xhttp.send("id="+$("input[name='id']").val()+"&name="+$("input[name='name']").val()+"&email="+$("input[name='email']").val());
}
$(()=>{
   $("button").click(()=>{
      regist();
   });
   //문서가 로드되면 기존에
   getList();
   
});
</script>
</head>
<body>
    <div class="container">
        <div class ="aside">
            <form>
                <input type="text" placeholder="Your ID..." name ="id">
                <input type="text"placeholder="Your name..."name ="name">
                <input type="text"placeholder="Your email..."name ="email">
                <button type="button">등록</button>
            </form>
        </div>
        <div class = "content">

        </div>
    </div>
</body>
</html>